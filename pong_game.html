<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="ROGO-icon.png">
    <title>‡πÄ‡∏Å‡∏°‡∏™‡πå‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏ó - Smooth Pong Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: url('photo.jpg') center/cover no-repeat fixed;
            background-color: #1a0033;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1;
            pointer-events: none;
        }

        .container {
            text-align: center;
            position: relative;
            z-index: 2;
        }

        h1 {
            color: white;
            margin-bottom: 50px;
            text-shadow: 0 0 20px rgba(0, 255, 136, 0.8), 0 0 40px rgba(0, 212, 255, 0.5);
            font-size: 2.5em;
            letter-spacing: 2px;
            animation: glowPulse 2s ease-in-out infinite;
            font-weight: 700;
        }

        @keyframes glowPulse {
            0%, 100% {
                text-shadow: 0 0 20px rgba(0, 255, 136, 0.8), 0 0 40px rgba(0, 212, 255, 0.5);
            }
            50% {
                text-shadow: 0 0 30px rgba(0, 255, 136, 1), 0 0 60px rgba(0, 212, 255, 0.8);
            }
        }

        canvas {
            background: linear-gradient(90deg, 
                rgba(0, 40, 80, 0.95) 0%, 
                rgba(0, 40, 80, 0.95) 50%, 
                rgba(20, 30, 50, 0.95) 50%, 
                rgba(20, 30, 50, 0.95) 100%);
            border: 3px solid #00d4ff;
            border-radius: 15px;
            box-shadow: 
                inset 0 0 30px rgba(0, 212, 255, 0.4),
                0 0 30px rgba(0, 212, 255, 0.6),
                0 0 60px rgba(0, 212, 255, 0.3);
            display: block;
            margin: 0 auto;
            transition: box-shadow 0.3s ease;
        }

        canvas:hover {
            box-shadow: 
                inset 0 0 40px rgba(0, 212, 255, 0.5),
                0 0 40px rgba(0, 212, 255, 0.8),
                0 0 80px rgba(0, 212, 255, 0.5);
        }

        .info {
            color: #00ffff;
            margin-top: 20px;
            font-size: 16px;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.6);
            letter-spacing: 0.5px;
        }

        .controls {
            color: #00d4ff;
            margin-top: 20px;
            font-size: 14px;
            animation: fadeIn 0.5s ease-in;
        }

        #controlInfo {
            background: rgba(26, 26, 46, 0.8);
            backdrop-filter: blur(10px);
            padding: 15px 25px;
            border-radius: 10px;
            border: 1px solid rgba(0, 212, 255, 0.5);
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }

        #controlInfo p {
            margin: 8px 0;
            letter-spacing: 1px;
            text-shadow: 0 0 8px rgba(0, 212, 255, 0.5);
        }

        #backButton button {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #backButton button:hover {
            box-shadow: 0 8px 35px rgba(0, 0, 0, 0.6), 0 0 30px rgba(255, 255, 255, 0.3);
        }

        #menuScreen {
            position: fixed;
            left: 30px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 100;
            animation: slideIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-50%) translateX(-100px);
            }
            to {
                opacity: 1;
                transform: translateY(-50%) translateX(0);
            }
        }

        .menu-box {
            background: rgba(26, 26, 46, 0.98);
            backdrop-filter: blur(15px);
            padding: 40px;
            border-radius: 20px;
            color: white;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 40px rgba(0, 212, 255, 0.6), 0 0 80px rgba(0, 212, 255, 0.3), inset 0 0 30px rgba(0, 255, 136, 0.05);
            pointer-events: auto;
            z-index: 101;
            transition: all 0.3s ease;
        }

        .menu-box:hover {
            box-shadow: 0 0 50px rgba(0, 212, 255, 0.8), 0 0 100px rgba(0, 212, 255, 0.4), inset 0 0 40px rgba(0, 255, 136, 0.1);
            border-color: #00ff88;
        }

        .menu-box h2 {
            color: #00ff88;
            margin-bottom: 25px;
            text-shadow: 0 0 15px rgba(0, 255, 136, 1);
            font-size: 1.8em;
            letter-spacing: 1px;
            animation: menuGlow 1.5s ease-in-out infinite;
        }

        @keyframes menuGlow {
            0%, 100% {
                text-shadow: 0 0 15px rgba(0, 255, 136, 0.8);
            }
            50% {
                text-shadow: 0 0 25px rgba(0, 255, 136, 1), 0 0 40px rgba(0, 212, 255, 0.6);
            }
        }

        .btn-mode {
            width: 100%;
            padding: 16px;
            margin: 12px 0;
            font-size: 16px;
            border: 2px solid;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            pointer-events: auto;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .btn-mode::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.2);
            transition: left 0.5s ease;
            z-index: -1;
        }

        .btn-mode:hover::before {
            left: 100%;
        }

        .btn-mode:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }

        .btn-mode:active {
            transform: translateY(-2px) scale(0.98);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }

        #btnAI {
            background: linear-gradient(135deg, #00d4ff, #0099cc);
            color: black;
            border-color: #00ff88;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        #btnAI:hover {
            box-shadow: 0 8px 30px rgba(0, 212, 255, 1), 0 0 20px rgba(0, 255, 136, 0.6);
            border-color: #00ffff;
        }

        #btn2Player {
            background: linear-gradient(135deg, #ff006e, #ff3385);
            color: white;
            border-color: #ff006e;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        #btn2Player:hover {
            box-shadow: 0 8px 30px rgba(255, 0, 110, 1), 0 0 20px rgba(255, 105, 180, 0.6);
            border-color: #ff0099;
        }

        .difficulty-buttons {
            display: none;
            animation: fadeIn 0.3s ease-in;
            margin-top: 15px;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0;
                transform: translateY(-10px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .difficulty-buttons.show {
            display: block;
        }

        .btn-diff {
            width: 48%;
            padding: 12px;
            margin: 8px 1%;
            font-size: 14px;
            border: 2px solid;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .btn-diff:hover {
            transform: scale(1.08) translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
        }

        #btnEasy {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            color: black;
            border-color: #00ff88;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        #btnEasy:hover {
            box-shadow: 0 6px 25px rgba(0, 255, 136, 0.9), 0 0 15px rgba(0, 255, 136, 0.6);
            border-color: #00ffaa;
        }

        #btnHard {
            background: linear-gradient(135deg, #ff3385, #ff006e);
            color: white;
            border-color: #ff006e;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        #btnHard:hover {
            box-shadow: 0 6px 25px rgba(255, 0, 110, 0.9), 0 0 15px rgba(255, 51, 133, 0.6);
            border-color: #ff0099;
        }

        #countdownDisplay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 140px;
            font-weight: 900;
            color: #00ff88;
            text-shadow: 0 0 40px rgba(0, 255, 136, 1), 0 0 80px rgba(0, 212, 255, 0.7), 0 0 120px rgba(0, 255, 136, 0.4);
            z-index: 201;
            display: none;
            animation: countdownPulse 0.6s ease-out;
            letter-spacing: 10px;
        }

        /* Dark overlay shown during countdown/rally */
        #countdownOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(4px);
            z-index: 200;
            display: none;
            transition: opacity 0.25s ease;
        }

        @keyframes countdownPulse {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.3) rotate(-20deg);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1) rotate(0deg);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.5) rotate(10deg);
            }
        }

        @keyframes scorePop {
            0% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.3);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        #liveScore {
            background: linear-gradient(135deg, rgba(0, 30, 60, 0.95), rgba(0, 20, 50, 0.98));
            padding: 16px 32px;
            border-radius: 12px;
            border: 2px solid #00d4ff;
            box-shadow: 0 0 30px rgba(0, 212, 255, 0.8), 0 0 60px rgba(0, 212, 255, 0.4), inset 0 0 20px rgba(0, 255, 136, 0.1);
            font-size: 20px;
            letter-spacing: 2px;
            color: #00ffff;
            font-weight: 700;
            backdrop-filter: blur(10px);
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.8);
            transition: all 0.3s ease;
            animation: float 3s ease-in-out infinite;
        }

        #liveScore:hover {
            box-shadow: 0 0 40px rgba(0, 212, 255, 1), 0 0 80px rgba(0, 212, 255, 0.6), inset 0 0 30px rgba(0, 255, 136, 0.2);
            border-color: #00ffff;
        }

        input[type="number"] {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #00d4ff;
            background: rgba(255, 255, 255, 0.95);
            color: #1a1a2e;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-align: center;
            letter-spacing: 1px;
        }

        input[type="number"]:focus {
            outline: none;
            box-shadow: 0 0 20px rgba(0, 212, 255, 0.8), inset 0 0 10px rgba(0, 255, 136, 0.2);
            border-color: #00ffff;
            transform: scale(1.02);
        }

        input[type="number"]:hover {
            border-color: #00ffff;
            box-shadow: 0 0 15px rgba(0, 212, 255, 0.6);
        }

        label {
            font-weight: 700;
            letter-spacing: 1px;
            text-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
            display: inline-block;
            animation: labelGlow 2s ease-in-out infinite;
        }

        @keyframes labelGlow {
            0%, 100% {
                text-shadow: 0 0 8px rgba(0, 255, 136, 0.6);
            }
            50% {
                text-shadow: 0 0 15px rgba(0, 255, 136, 1), 0 0 20px rgba(0, 212, 255, 0.6);
            }
        }

        ::placeholder {
            color: rgba(255, 255, 255, 0.5);
            opacity: 1;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(26, 26, 46, 0.5);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #00d4ff, #00ff88);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #00ffff, #00ffaa);
        }

        #fbButton {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 99;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid transparent;
            background: transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        #fbButton img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            transition: all 0.3s ease;
        }

        #fbButton:hover {
            transform: scale(1.1);
            border-color: #ffffff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8), 0 0 40px rgba(255, 255, 255, 0.4), inset 0 0 20px rgba(255, 255, 255, 0.2);
        }

        #fbButton:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body>
    <a id="fbButton" href="https://www.facebook.com/pd.si.604028" target="_blank" rel="noopener noreferrer">
        <img src="F.png" alt="Facebook">
    </a>
    <div class="container">
        <h1>üéÆ ‡πÄ‡∏Å‡∏°‡∏™‡πå‡∏•‡∏π‡∏Å‡∏ö‡∏¥‡∏ó Smooth Pong üéÆ</h1>
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        
        <div id="menuScreen">
            <div class="menu-box">
                <h2>‚öîÔ∏è ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡πà‡∏ô</h2>
                <div style="margin-bottom:12px; color:#bff;">
                    <label for="targetScoreInput" style="display:block; margin-bottom:6px; color:#00ff88;">‡πÅ‡∏ï‡πâ‡∏°‡∏ä‡∏ô‡∏∞ (‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç)</label>
                    <input id="targetScoreInput" type="number" min="1" value="5" style="width:100%; padding:8px; border-radius:6px; border:1px solid #00d4ff;">
                </div>
                <button id="btnAI" class="btn-mode" onclick="document.getElementById('aiDifficulty').classList.add('show')">
                    ü§ñ ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö AI
                </button>
                <div id="aiDifficulty" class="difficulty-buttons">
                    <button id="btnEasy" class="btn-diff" onclick="gameMode='ai';aiDifficulty='easy';startCountdown();">‡∏á‡πà‡∏≤‡∏¢</button>
                    <button id="btnHard" class="btn-diff" onclick="gameMode='ai';aiDifficulty='hard';startCountdown();">‡∏¢‡∏≤‡∏Å</button>
                </div>
                <button id="btn2Player" class="btn-mode" onclick="gameMode='twoPlayer';startCountdown();">
                    üë• ‡πÄ‡∏•‡πà‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô
                </button>
            </div>
        </div>
        
        <div id="countdownDisplay">3</div>
        <div id="countdownOverlay"></div>
        <div id="liveScoreP1" style="position:absolute; top:80px; left:50px; color:#00d4ff; font-weight:bold; display:none; z-index:60; font-size:18px; text-shadow: 0 0 10px rgba(0, 212, 255, 0.8);">üîµ P1: 0</div>
        <div id="liveScoreP2" style="position:absolute; top:80px; right:50px; color:#ff006e; font-weight:bold; display:none; z-index:60; font-size:18px; text-shadow: 0 0 10px rgba(255, 0, 110, 0.8);">P2: 0 üî¥</div>
        <div id="liveScoreMid" style="position:absolute; top:80px; left:50%; transform:translateX(-50%); color:#00ffff; font-weight:bold; display:none; z-index:60; font-size:16px; text-shadow: 0 0 8px rgba(0, 212, 255, 0.6); letter-spacing:1px;">(‡πÅ‡∏ï‡πâ‡∏°‡∏ä‡∏ô‡∏∞: 5)</div>
        
        <div class="controls">
            <div id="controlInfo">
                <p id="p1Control">üîµ: W/S | üî¥: ‚¨ÜÔ∏è/‚¨áÔ∏è</p>
            </div>
            <div id="quitButton" style="display: none; margin-top: 12px;">
                <button id="btnQuit" class="btn-mode" style="width: auto; padding: 10px 18px; background: linear-gradient(135deg, #ff6b6b, #ff4444); border-color: #ff0000;" onclick="quitGame()">‚ùå ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏°‡∏™‡πå</button>
            </div>
            <div id="backButton" style="display: none; margin-top: 12px;">
                <button id="btnBack" class="btn-mode" style="width: auto; padding: 10px 18px;" onclick="location.reload()">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π</button>
            </div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Game state
        let gameMode = null; // 'ai' or 'twoPlayer'
        let aiDifficulty = 'easy'; // 'easy' or 'hard'
        let gameRunning = false;
        let isCountingDown = false;
        let isRallyCountdown = false;
        let score = 0;
        let score2 = 0;
        let combo = 0;
        let targetScore = 5;
        let winner = null;
        let keys = {};
        let lightningFrames = 0;
        let waveParticles = [];
        let countdownInterval = null;
        let rallyCountdownInterval = null;

        // Game objects
        const paddle1 = { // left, blue (W/S or ‡πÑ/‡∏´)
            x: 20,
            y: canvas.height / 2 - 50,
            width: 15,
            height: 100,
            dy: 0,
            speed: 8,
            maxSpeed: 8,
            color: '#00d4ff'
        };

        const paddle2 = { // right, red (ArrowUp/ArrowDown)
            x: canvas.width - 35,
            y: canvas.height / 2 - 50,
            width: 15,
            height: 100,
            dy: 0,
            speed: 8,
            maxSpeed: 8,
            color: '#ff006e'
        };

        const ball = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            radius: 8,
            vx: 5,
            vy: 5,
            speed: 5,
            color: '#00ff88',
            visible: true
        };

        const aiPaddle = {
            x: canvas.width - 35,
            y: canvas.height / 2 - 50,
            width: 15,
            height: 100,
            dy: 0,
            speed: 6,
            color: '#ff006e'
        };

        // Menu/business logic
        document.getElementById('btnAI').addEventListener('click', () => {
            document.getElementById('aiDifficulty').classList.add('show');
        });

        document.getElementById('btnEasy').addEventListener('click', () => {
            gameMode = 'ai';
            aiDifficulty = 'easy';
            startCountdown();
        });

        document.getElementById('btnHard').addEventListener('click', () => {
            gameMode = 'ai';
            aiDifficulty = 'hard';
            startCountdown();
        });

        document.getElementById('btn2Player').addEventListener('click', () => {
            gameMode = 'twoPlayer';
            startCountdown();
        });

        // Rally countdown (3..2..1) between each point
        function startRallyCountdown() {
            if (isRallyCountdown) return;
            if (rallyCountdownInterval) clearInterval(rallyCountdownInterval);
            isRallyCountdown = true;
            let count = 3;
            const countdownEl = document.getElementById('countdownDisplay');
            countdownEl.style.display = 'block';
            document.getElementById('countdownOverlay').style.display = 'block';
            countdownEl.textContent = count;

            rallyCountdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                } else {
                    clearInterval(rallyCountdownInterval);
                    rallyCountdownInterval = null;
                    countdownEl.style.display = 'none';
                    document.getElementById('countdownOverlay').style.display = 'none';
                    isRallyCountdown = false;
                    gameRunning = true;
                    resetBall();
                    document.getElementById('backButton').style.display = 'none';
                    const p1 = document.getElementById('liveScoreP1');
                    const p2 = document.getElementById('liveScoreP2');
                    const mid = document.getElementById('liveScoreMid');
                    if (p1) p1.style.display = 'block';
                    if (p2) p2.style.display = 'block';
                    if (mid) mid.style.display = 'block';
                }
            }, 600);
        }

        // Countdown (3..2..1) then start immediately
        function startCountdown() {
            if (isCountingDown) return;
            // Clear any existing countdown/rally intervals to prevent stacking
            if (countdownInterval) clearInterval(countdownInterval);
            if (rallyCountdownInterval) clearInterval(rallyCountdownInterval);
            
            // read target score from menu input
            const tEl = document.getElementById('targetScoreInput');
            const parsed = parseInt(tEl && tEl.value, 10);
            targetScore = (Number.isFinite(parsed) && parsed > 0) ? parsed : 5;
            // reset scores
            score = 0; score2 = 0; combo = 0; winner = null;
            isCountingDown = true;
            // Hide menu immediately
            document.getElementById('menuScreen').style.display = 'none';
            document.getElementById('controlInfo').style.display = 'block';
            document.getElementById('quitButton').style.display = 'block';
            let count = 3;
            const countdownEl = document.getElementById('countdownDisplay');
            countdownEl.style.display = 'block';
            document.getElementById('countdownOverlay').style.display = 'block';
            countdownEl.textContent = count;
            // Show score box at the start of countdown
            const p1 = document.getElementById('liveScoreP1');
            const p2 = document.getElementById('liveScoreP2');
            const mid = document.getElementById('liveScoreMid');
            if (p1) p1.style.display = 'block';
            if (p2) p2.style.display = 'block';
            if (mid) mid.style.display = 'block';
            updateScore();

            countdownInterval = setInterval(() => {
                count--;
                if (count > 0) {
                    countdownEl.textContent = count;
                } else {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    countdownEl.style.display = 'none';
                    document.getElementById('countdownOverlay').style.display = 'none';
                    isCountingDown = false;
                    gameRunning = true;
                    resetBall();
                    resetPaddles();
                    document.getElementById('p2Control').style.display = gameMode === 'twoPlayer' ? 'block' : 'none';
                    document.getElementById('backButton').style.display = 'none';
                    const p1 = document.getElementById('liveScoreP1');
                    const p2 = document.getElementById('liveScoreP2');
                    const mid = document.getElementById('liveScoreMid');
                    if (p1) p1.style.display = 'block';
                    if (p2) p2.style.display = 'block';
                    if (mid) mid.style.display = 'block';
                    updateScore();
                }
            }, 1000);
        }

        // Input handling
        window.addEventListener('keydown', (e) => {
            const k = e.key.toLowerCase();
            keys[k] = true;
            if (e.key === ' ') {
                e.preventDefault();
                if (gameMode && !gameRunning && !isCountingDown) startCountdown();
                else if (!gameMode) return; // nothing
                else if (!isCountingDown && !gameRunning) startCountdown();
            }
        });

        window.addEventListener('keyup', (e) => {
            const k = e.key.toLowerCase();
            keys[k] = false;
        });

        // Reset ball
        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            const dir = Math.random() > 0.5 ? 1 : -1;
            ball.vx = dir * (4 + Math.random() * 2);
            ball.vy = (Math.random() - 0.5) * 6;
            combo = 0;
            // make sure ball is visible again when rally starts
            ball.visible = true;
            ball.radius = 8;
            updateScore();
        }

        function resetPaddles() {
            paddle1.y = (canvas.height - paddle1.height) / 2;
            paddle2.y = (canvas.height - paddle2.height) / 2;
        }

        function updateScore() {
            const p1 = document.getElementById('liveScoreP1');
            const p2 = document.getElementById('liveScoreP2');
            const mid = document.getElementById('liveScoreMid');
            if (p1) p1.textContent = `üîµ P1: ${score}`;
            if (p2) p2.textContent = `P2: ${score2} üî¥`;
            if (mid) mid.textContent = `(‡πÅ‡∏ï‡πâ‡∏°‡∏ä‡∏ô‡∏∞: ${targetScore})`;
        }

        // Paddle updates
        function updatePaddle1() { // left: W/S or ‡πÑ/‡∏´
            const up = keys['w'] || keys['‡πÑ'];
            const down = keys['s'] || keys['‡∏´'];
            if (up && paddle1.y > 0) paddle1.dy = -paddle1.maxSpeed;
            else if (down && paddle1.y < canvas.height - paddle1.height) paddle1.dy = paddle1.maxSpeed;
            else paddle1.dy *= 0.85;
            paddle1.y += paddle1.dy;
            paddle1.y = Math.max(0, Math.min(canvas.height - paddle1.height, paddle1.y));
        }

        function updatePaddle2() { // right: Arrow keys
            const up = keys['arrowup'];
            const down = keys['arrowdown'];
            if (up && paddle2.y > 0) paddle2.dy = -paddle2.maxSpeed;
            else if (down && paddle2.y < canvas.height - paddle2.height) paddle2.dy = paddle2.maxSpeed;
            else paddle2.dy *= 0.85;
            paddle2.y += paddle2.dy;
            paddle2.y = Math.max(0, Math.min(canvas.height - paddle2.height, paddle2.y));
        }

        // AI update
        function updateAI() {
            const target = ball.y;
            let speed = aiPaddle.speed;
            if (aiDifficulty === 'hard') speed += 2;
            const aiCenter = aiPaddle.y + aiPaddle.height / 2;
            if (aiCenter < target - 20) aiPaddle.dy = speed;
            else if (aiCenter > target + 20) aiPaddle.dy = -speed;
            else aiPaddle.dy *= 0.9;
            aiPaddle.y += aiPaddle.dy;
            aiPaddle.y = Math.max(0, Math.min(canvas.height - aiPaddle.height, aiPaddle.y));
        }

        // Ball physics
        function updateBall() {
            ball.x += ball.vx;
            ball.y += ball.vy;
            // top/bottom
            if (ball.y - ball.radius < 0 || ball.y + ball.radius > canvas.height) {
                ball.vy *= -1;
                ball.y = Math.max(ball.radius, Math.min(canvas.height - ball.radius, ball.y));
            }

            // left paddle collision (no point awarded here; points on miss)
            if (ball.x - ball.radius < paddle1.x + paddle1.width && ball.y > paddle1.y && ball.y < paddle1.y + paddle1.height) {
                ball.vx = Math.abs(ball.vx) * 1.02;
                const hitPos = (ball.y - (paddle1.y + paddle1.height / 2)) / (paddle1.height / 2);
                ball.vy = hitPos * 8;
                ball.x = paddle1.x + paddle1.width + ball.radius;
                ball.color = '#00d4ff';
                combo++;
                // Add wave effect
                createWave(ball.x, ball.y, '#00d4ff');
                // Add explosion effect
                createExplosion(ball.x, ball.y, '#00d4ff');
            }

            // right paddle collision (AI or player)
            const right = gameMode === 'twoPlayer' ? paddle2 : aiPaddle;
            if (ball.x + ball.radius > right.x && ball.y > right.y && ball.y < right.y + right.height) {
                ball.vx = -Math.abs(ball.vx) * 1.02;
                const hitPos = (ball.y - (right.y + right.height / 2)) / (right.height / 2);
                ball.vy = hitPos * 8;
                ball.x = right.x - ball.radius;
                ball.color = '#ff006e';
                combo++;
                // Add wave effect
                createWave(ball.x, ball.y, '#ff006e');
                // Add explosion effect
                createExplosion(ball.x, ball.y, '#ff006e');
            }

            // out of bounds -> award point to opponent and check for match end
            if (ball.x < 0 || ball.x > canvas.width) {
                combo = 0;
                if (ball.x < 0) {
                    // right player scores - burst with red at left edge
                    score2 += 1;
                    lightningFrames = 10;
                    createExplosion(0, ball.y, '#ff006e');
                } else {
                    // left player scores - burst with blue at right edge
                    score += 1;
                    lightningFrames = 10;
                    createExplosion(canvas.width, ball.y, '#00d4ff');
                }
                // hide/stop the ball so it disappears while explosion plays and during countdown
                ball.visible = false;
                ball.vx = 0; ball.vy = 0;
                updateScore();
                // check win
                if (score >= targetScore || score2 >= targetScore) {
                    winner = score >= targetScore ? 'blue' : 'red';
                    gameRunning = false;
                    // Clear any running intervals
                    if (countdownInterval) clearInterval(countdownInterval);
                    if (rallyCountdownInterval) clearInterval(rallyCountdownInterval);
                    countdownInterval = null;
                    rallyCountdownInterval = null;
                    
                    document.getElementById('controlInfo').style.display = 'none';
                    document.getElementById('quitButton').style.display = 'block';
                } else {
                    // Continue game immediately after scoring, then show countdown for next rally
                    gameRunning = false;
                    resetPaddles();  // Reset paddles to center
                    // Schedule the rally countdown to start after particles finish rendering
                    setTimeout(() => {
                        startRallyCountdown();
                    }, 800);
                }
            }
        }

        // Update quit button visibility
        function updateQuitButtonVisibility() {
            const quitBtn = document.getElementById('quitButton');
            if (gameMode && (gameRunning || isRallyCountdown || isCountingDown)) {
                quitBtn.style.display = 'block';
            } else {
                quitBtn.style.display = 'none';
            }
        }

        // Draw
        function drawPaddle(p) {
            ctx.fillStyle = p.color;
            const shadow = p.color === '#00d4ff' ? 'rgba(0,212,255,0.8)' : 'rgba(255,0,110,0.8)';
            ctx.shadowColor = shadow;
            ctx.shadowBlur = 15;
            ctx.fillRect(p.x, p.y, p.width, p.height);
            ctx.shadowColor = 'transparent';
        }

        function drawBall() {
            if (!ball.visible) return;
            ctx.fillStyle = ball.color;
            ctx.shadowColor = ball.color === '#00d4ff' ? 'rgba(0,212,255,0.8)' : 
                              ball.color === '#ff006e' ? 'rgba(255,0,110,0.8)' : 'rgba(0,255,136,0.8)';
            ctx.shadowBlur = 20;
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowColor = 'transparent';
        }

        function drawCenterLine() {
            ctx.strokeStyle = 'rgba(255,255,255,0.08)';
            ctx.setLineDash([10, 10]);
            ctx.beginPath();
            ctx.moveTo(canvas.width / 2, 0);
            ctx.lineTo(canvas.width / 2, canvas.height);
            ctx.stroke();
            ctx.setLineDash([]);
        }

        function drawSplitBorder() {
            // Left side border - blue only
            ctx.strokeStyle = '#00d4ff';
            ctx.lineWidth = 3;
            ctx.shadowColor = 'rgba(0,212,255,0.8)';
            ctx.shadowBlur = 15;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(0, canvas.height);
            ctx.stroke();

            ctx.shadowColor = 'transparent';
        }

        function createWave(x, y, color) {
            for (let i = 0; i < 8; i++) {
                const angle = (i / 8) * Math.PI * 2;
                waveParticles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * 3,
                    vy: Math.sin(angle) * 3,
                    life: 1,
                    color: color,
                    radius: 3
                });
            }
        }

        function createExplosion(x, y, color) {
            // Create scatter/lightning burst particles - light effect
            for (let i = 0; i < 6; i++) {
                const angle = (i / 6) * Math.PI * 2;
                waveParticles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * 3,
                    vy: Math.sin(angle) * 3,
                    life: 1,
                    color: color,
                    radius: 1,
                    isExplosion: true
                });
            }
        }

        function createEnhancedExplosion(x, y, color) {
            // Create more intense explosion for paddle hits
            for (let i = 0; i < 24; i++) {
                const angle = (i / 24) * Math.PI * 2;
                waveParticles.push({
                    x: x,
                    y: y,
                    vx: Math.cos(angle) * 10,
                    vy: Math.sin(angle) * 10,
                    life: 1,
                    color: color,
                    radius: 4,
                    isExplosion: true
                });
            }
        }

        function updateWaves() {
            for (let i = waveParticles.length - 1; i >= 0; i--) {
                const p = waveParticles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.05;
                p.radius += 0.1;
                if (p.life <= 0) {
                    waveParticles.splice(i, 1);
                }
            }
        }

        function drawWaves() {
            for (const p of waveParticles) {
                ctx.globalAlpha = p.life;
                ctx.strokeStyle = p.color;
                
                if (p.isExplosion) {
                    // Draw lightning-like scatter effect - light
                    ctx.lineWidth = 1.5;
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 5;
                } else {
                    // Draw wave circles
                    ctx.lineWidth = 2;
                    ctx.shadowColor = 'transparent';
                }
                
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.stroke();
            }
            ctx.globalAlpha = 1;
            ctx.shadowColor = 'transparent';
        }

        function drawLightning(x, y) {
            if (lightningFrames <= 0) return;
            const alpha = lightningFrames / 10;
            ctx.globalAlpha = alpha * 0.6;
            ctx.strokeStyle = '#ffff00';
            ctx.lineWidth = 3;
            ctx.shadowColor = 'rgba(255,255,0,0.8)';
            ctx.shadowBlur = 20;
            for (let i = 0; i < 3; i++) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                const branches = 5;
                for (let j = 0; j < branches; j++) {
                    const segX = x + (Math.random() - 0.5) * 60;
                    const segY = (j / branches) * canvas.height;
                    ctx.lineTo(segX, segY);
                }
                ctx.stroke();
            }
            ctx.shadowColor = 'transparent';
            ctx.globalAlpha = 1;
            lightningFrames--;
        }

        function drawStartScreen() {
            // Draw is not needed during countdown - this function is only called when no game is running
        }

        function drawGameOver() {
            ctx.fillStyle = 'rgba(0,0,0,0.6)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#00ff88';
            ctx.font = 'bold 40px Arial';
            ctx.textAlign = 'center';
            ctx.shadowColor = 'rgba(0,255,136,0.8)';
            ctx.shadowBlur = 10;
            let title = 'GAME OVER';
            if (winner === 'blue') {
                ctx.fillStyle = '#00d4ff';
                title = 'üîµ ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: ‡∏™‡∏µ‡∏ü‡πâ‡∏≤';
            } else if (winner === 'red') {
                ctx.fillStyle = '#ff006e';
                title = 'üî¥ ‡∏ú‡∏π‡πâ‡∏ä‡∏ô‡∏∞: ‡∏™‡∏µ‡πÅ‡∏î‡∏á';
            }
            ctx.fillText(title, canvas.width / 2, canvas.height / 2 - 30);
            ctx.fillStyle = '#00d4ff';
            ctx.font = '20px Arial';
            ctx.fillText('‡∏Å‡∏î ‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÄ‡∏°‡∏ô‡∏π ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î Space ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà', canvas.width / 2, canvas.height / 2 + 20);
            ctx.shadowColor = 'transparent';
        }

        // Game loop
        function gameLoop() {
            // Clear
            ctx.fillStyle = 'rgba(22,33,62,1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            drawCenterLine();
            drawSplitBorder();

            if (!gameMode) {
                requestAnimationFrame(gameLoop);
                return;
            }

            if (gameRunning) {
                if (gameMode === 'twoPlayer') {
                    updatePaddle1();
                    updatePaddle2();
                } else {
                    updatePaddle1();
                    updateAI();
                }
                updateBall();
            } else if (winner) {
                drawGameOver();
            } else {
                drawStartScreen();
            }
            
            // Always update particles regardless of game state
            updateWaves();

            // Draw paddles/ball
            drawPaddle(paddle1);
            if (gameMode === 'twoPlayer') drawPaddle(paddle2); else drawPaddle(aiPaddle);
            drawBall();
            drawWaves();

            requestAnimationFrame(gameLoop);
        }

        // Back button
        document.getElementById('btnBack')?.addEventListener('click', () => {
            location.reload();
        });

        // Quit game function
        function quitGame() {
            location.reload();
        }

        // Start
        updateScore();
        gameLoop();
    </script>
</body>
</html>
